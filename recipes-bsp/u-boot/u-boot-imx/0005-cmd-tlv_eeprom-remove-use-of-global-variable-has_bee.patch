From 29341e197b408048085af3fd6d3613cf3de5dc1c Mon Sep 17 00:00:00 2001
From: Josua Mayer <josua@solid-run.com>
Date: Mon, 2 May 2022 17:18:28 +0300
Subject: [PATCH 05/21] cmd: tlv_eeprom: remove use of global variable
 has_been_read

has_been_read is only used as an optimization for do_tlv_eeprom.
Explicitly use and set inside this function, thus making read_eeprom
stateless.

Signed-off-by: Josua Mayer <josua@solid-run.com>
Reviewed-by: Stefan Roese <sr@denx.de>
---
 cmd/tlv_eeprom.c | 15 +++++++--------
 1 file changed, 7 insertions(+), 8 deletions(-)

diff --git a/cmd/tlv_eeprom.c b/cmd/tlv_eeprom.c
index 57cfd355df1..acbd198d575 100644
--- a/cmd/tlv_eeprom.c
+++ b/cmd/tlv_eeprom.c
@@ -427,20 +427,20 @@ int do_tlv_eeprom(struct cmd_tbl *cmdtp, int flag, int argc, char *const argv[])
 	char cmd;
 	struct tlvinfo_header *eeprom_hdr = to_header(eeprom);
 	static unsigned int current_dev;
-	/* Set to 1 if we've read EEPROM into memory */
-	static int has_been_read;
+	/* Set to devnum if we've read EEPROM into memory */
+	static int has_been_read = -1;
 	int ret;
 
 	// If no arguments, read the EERPOM and display its contents
 	if (argc == 1) {
-		if (!has_been_read) {
+		if (has_been_read != current_dev) {
 			ret = read_eeprom(current_dev, eeprom);
 			if (ret) {
 				printf("Failed to read EEPROM data from device.\n");
 				return 0;
 			}
 
-			has_been_read = 1;
+			has_been_read = current_dev;
 		}
 		show_eeprom(current_dev, eeprom);
 		return 0;
@@ -461,14 +461,14 @@ int do_tlv_eeprom(struct cmd_tbl *cmdtp, int flag, int argc, char *const argv[])
 			return 0;
 		}
 		current_dev = devnum;
-		has_been_read = 0;
 
 		return 0;
 	}
 
 	// Read the EEPROM contents
 	if (cmd == 'r') {
-		has_been_read = 0;
+		has_been_read = -1;
 		ret = read_eeprom(current_dev, eeprom);
 		if (ret) {
 			printf("Failed to read EEPROM data from device.\n");
@@ -476,11 +475,11 @@ int do_tlv_eeprom(struct cmd_tbl *cmdtp, int flag, int argc, char *const argv[])
 		}
 
 		printf("EEPROM data loaded from device to memory.\n");
-		has_been_read = 1;
+		has_been_read = current_dev;
 	}
 
 	// Subsequent commands require that the EEPROM has already been read.
-	if (!has_been_read) {
+	if (has_been_read != current_dev) {
 		printf("Please read the EEPROM data first, using the 'tlv_eeprom read' command.\n");
 		return 0;
 	}
